<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>Link Expert | Management</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		:root {
			--bg: #050505;
			--panel: rgba(22, 22, 24, 0.8);
			--text: #e0e0e0;
			--accent: #d4af37; /* Royal Gold */
			--border: rgba(212, 175, 55, 0.25);
			--glass: rgba(255, 255, 255, 0.04);
			--blur: blur(25px);
			--max-w: 500px; /* Default Mobile */
		}

		body.glass-light {
			--bg: #f2f2f7; --panel: rgba(255, 255, 255, 0.6); --text: #1c1c1e; --accent: #007aff; --border: rgba(0,0,0,0.1);
		}

		/* Desktop Mode Override */
		body.desktop-mode { --max-w: 1200px; }
		body.desktop-mode #results { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
		body.desktop-mode .stat-grid { grid-template-columns: 1fr 1fr 1fr; }

		body { 
			margin: 0; background: var(--bg); color: var(--text); 
			font-family: 'SF Pro Display', -apple-system, sans-serif; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
			padding-bottom: 120px; line-height: 1.6;
		}

		/* Login Screen */
		#login { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
		.login-card { 
			background: var(--panel); backdrop-filter: var(--blur); padding: 40px 30px; 
			border-radius: 30px; text-align: center; width: 88%; max-width: 380px; 
			border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5);
		}

		header {
			background: var(--panel); backdrop-filter: var(--blur); padding: 12px 20px;
			position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border);
		}
		.nav-inner { max-width: var(--max-w); margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }

		/* Inputs & Search */
		.container { width: 92%; max-width: var(--max-w); margin: 25px auto; transition: 0.3s; }
		.search-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
		
		input, select { 
			width: 100%; padding: 16px; border-radius: 14px; border: 1px solid var(--border); 
			background: var(--glass); color: var(--text); font-size: 15px; box-sizing: border-box; outline: none;
		}
		input:focus { border-color: var(--accent); background: rgba(255,255,255,0.08); }

		/* Cards */
		.car-card {
			background: var(--panel); border-radius: 22px; padding: 22px; margin-bottom: 18px;
			border: 1px solid var(--border); transition: 0.3s; cursor: pointer; position: relative;
		}
		.car-card:active { transform: scale(0.97); }
		.c-plate { font-size: 28px; font-weight: 900; letter-spacing: 2px; margin: 10px 0; color: var(--text); }
		.c-tag { font-size: 12px; font-weight: bold; padding: 4px 10px; border-radius: 8px; background: var(--accent); color: #000; }

		/* Settings Dropdown */
		.settings-pane {
			display: none; position: absolute; right: 20px; top: 65px; 
			background: var(--panel); backdrop-filter: var(--blur); width: 220px;
			border-radius: 20px; border: 1px solid var(--border); z-index: 2000; overflow: hidden;
			box-shadow: 0 15px 40px rgba(0,0,0,0.6);
		}
		.set-item { 
			padding: 14px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); 
			display: flex; align-items: center; gap: 12px; font-size: 14px; cursor: pointer; transition: 0.2s;
		}
		.set-item:hover { background: var(--accent); color: #000; }

		/* Bottom Nav */
		.dock-bar {
			position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
			width: 90%; max-width: 420px; background: var(--panel); backdrop-filter: var(--blur);
			border-radius: 50px; border: 1px solid var(--border); display: flex; padding: 8px; z-index: 999;
		}
		.tab { flex: 1; text-align: center; padding: 14px; border-radius: 40px; color: var(--text); opacity: 0.4; cursor: pointer; font-size: 22px; }
		.tab.active { background: var(--accent); color: #000; opacity: 1; box-shadow: 0 4px 15px rgba(212,175,55,0.3); }

		.btn-main { background: var(--accent); color: #000; font-weight: 800; border: none; padding: 18px; border-radius: 16px; cursor: pointer; width: 100%; transition: 0.3s; }
		.btn-main:hover { opacity: 0.9; }

		.owner-badge { display: none; background: #d4af3722; color: var(--accent); border: 1px solid var(--accent); padding: 2px 8px; border-radius: 6px; font-size: 10px; margin-left: 5px; }

		@media (max-width: 480px) { .search-row { grid-template-columns: 1fr; } }
	</style>
</head>
<body class="royal-mode">

	<div id="login">
		<div class="login-card">
			<img src="linkexpert.png" alt="Link Expert" style="height: 65px; margin-bottom: 15px;">
			<h2 style="color: var(--accent); letter-spacing: 1px; margin-bottom: 30px;">PARKING PRO</h2>
			<input type="text" id="u" placeholder="Email/Username" style="margin-bottom:12px">
			<input type="password" id="p" placeholder="Security Password" style="margin-bottom:25px">
			<button class="btn-main" onclick="handleLogin()">AUTHENTICATE</button>
		</div>
	</div>

	<header>
		<div class="nav-inner">
			<div style="display:flex; align-items:center; gap:12px;">
				<img src="linkexpert.png" style="height: 38px;">
				<span style="font-weight:900; letter-spacing:1px; font-size:18px;">LINK <span style="color:var(--accent)">EXPERT</span></span>
			</div>
			<div style="position:relative;">
				<button class="tab" style="opacity:1; font-size:18px" onclick="toggleSettings()"><i class="fas fa-sliders"></i></button>
				<div id="settingsPane" class="settings-pane">
					<div class="set-item" onclick="toggleViewMode()"><i id="viewIcon" class="fas fa-desktop"></i> <span id="viewText">Desktop Mode</span></div>
					<div class="set-item" onclick="setTheme('royal')"><i class="fas fa-moon"></i> Royal Black</div>
					<div class="set-item" onclick="setTheme('light')"><i class="fas fa-sun"></i> Glass Light</div>
					<div id="ownerSection" class="set-item" style="display:none;" onclick="alert('User Management Console')"><i class="fas fa-user-gear"></i> Manage Users</div>
					<div class="set-item" style="color:var(--accent)"><i class="fas fa-circle-info"></i> About System</div>
					<div class="set-item" onclick="location.reload()" style="color:#ff3b30; border:none"><i class="fas fa-power-off"></i> Sign Out</div>
				</div>
			</div>
		</div>
	</header>

	<div class="container">
		<section id="page-search">
			<div class="search-row">
				<input type="text" id="findPlate" placeholder="Plate Number..." onkeyup="runFilter()">
				<input type="text" id="findMeta" placeholder="Client/Model/Color..." onkeyup="runFilter()">
			</div>
			<div id="results"></div>
		</section>

		<section id="page-entry" style="display:none">
			<div class="car-card" style="border-style: dashed; cursor: default;">
				<h3 style="margin-top:0"><i class="fas fa-barcode"></i> Entry Registration</h3>
				<label style="font-size:12px; opacity:0.6">SELECTED VEHICLE</label>
				<input type="text" id="target" readonly style="margin:8px 0 15px 0; border-color:var(--accent)">
				<div class="search-row">
					<select id="unit">
						<option>P1-VIP</option><option>P1</option><option>P2</option><option>P3</option><option>P4</option><option>Landscape</option>
					</select>
					<input type="number" id="slot" placeholder="Slot #">
				</div>
				<button class="btn-main" onclick="pushData()">COMMIT TO CLOUD</button>
			</div>
		</section>

		<section id="page-stats" style="display:none">
			<div class="stat-grid" style="display: grid; gap:15px;">
				<div class="car-card"><canvas id="chartArea"></canvas></div>
			</div>
		</section>
	</div>

	<nav class="dock-bar">
		<div class="tab active" onclick="navTo('page-search', this)"><i class="fas fa-house-chimney"></i></div>
		<div class="tab" onclick="navTo('page-entry', this)"><i class="fas fa-square-plus"></i></div>
		<div class="tab" onclick="navTo('page-stats', this); loadAnalytics();"><i class="fas fa-chart-pie"></i></div>
	</nav>

	<script>
		let db = [];
		let role = "guest";
		const API_URL = "https://script.google.com/macros/s/AKfycbwsP1l8xwMMJKrNHkzmfZYhnWlqE0QAs3K7C91LOLatDtwNzJ5zKtCadsbzQCKHMQhJ/exec";

		function handleLogin() {
			const u = document.getElementById('u').value, p = document.getElementById('p').value;
			if(u === "asim@link.sa" && p === "0707") { role = "owner"; init(); }
			else if(u === "abdullah@awtad.sa" && p === "3344") { role = "client"; init(); }
			else alert("Authentication Failed.");
		}

		function init() {
			document.getElementById('login').style.display='none';
			if(role === "owner") document.getElementById('ownerSection').style.display = 'flex';
			fetchFromSheets();
		}

		async function fetchFromSheets() {
			try {
				const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRytRL1hkkvWkTEnU0oSTpUSG39VuigUKFyPYcEHLwX0W76gNiGLX5sKNIXSHki16Z6JCBwE8LpW8MU/pub?gid=917848047&single=true&output=csv");
				const text = await res.text();
				const lines = text.split('\n').filter(l => l.trim() !== '');
				db = lines.slice(1).map(l => {
					const c = l.split(',').map(v => v.trim());
					return { name: c[0], plate: c[1], model: c[2], color: c[3], status: c[5] };
				});
				render(db);
			} catch(e) { alert("Cloud Sync Failed"); }
		}

		function render(data) {
			const list = document.getElementById('results'); list.innerHTML = '';
			data.forEach(v => {
				const div = document.createElement('div');
				div.className = 'car-card';
				div.innerHTML = `
					<div style="display:flex; justify-content:space-between; align-items:center">
						<span class="c-tag">${v.name}</span>
						<i class="fas fa-share-nodes" style="color:var(--accent)" onclick="share('${v.name}','${v.plate}')"></i>
					</div>
					<div class="c-plate">${v.plate}</div>
					<div style="font-size:13px; opacity:0.7">${v.model} â€¢ ${v.color}</div>
				`;
				div.onclick = (e) => {
					if(e.target.tagName !== 'I') {
						document.getElementById('target').value = v.plate + " (" + v.name + ")";
						navTo('page-entry', document.querySelectorAll('.tab')[1]);
					}
				};
				list.appendChild(div);
			});
		}

		function runFilter() {
			const p = document.getElementById('findPlate').value.toLowerCase();
			const m = document.getElementById('findMeta').value.toLowerCase();
			const filtered = db.filter(x => x.plate.toLowerCase().includes(p) && 
				(x.name.toLowerCase().includes(m) || x.model.toLowerCase().includes(m) || x.color.toLowerCase().includes(m)));
			render(filtered);
		}

		function toggleViewMode() {
			const isDesktop = document.body.classList.toggle('desktop-mode');
			document.getElementById('viewIcon').className = isDesktop ? "fas fa-mobile-screen" : "fas fa-desktop";
			document.getElementById('viewText').innerText = isDesktop ? "Mobile View" : "Desktop Mode";
			toggleSettings();
		}

		function setTheme(t) {
			document.body.className = (t === 'light') ? 'glass-light' : 'royal-mode';
			if(document.body.classList.contains('desktop-mode')) document.body.classList.add('desktop-mode');
			toggleSettings();
		}

		function navTo(page, el) {
			document.querySelectorAll('section').forEach(s => s.style.display='none');
			document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
			document.getElementById(page).style.display='block';
			el.classList.add('active');
		}

		function toggleSettings() {
			const s = document.getElementById('settingsPane');
			s.style.display = (s.style.display === 'block') ? 'none' : 'block';
		}

		function share(n, p) {
			const txt = `*LINK EXPERT PARKING*\nClient: ${n}\nPlate: ${p}`;
			navigator.share ? navigator.share({title: 'Vehicle Info', text: txt}) : window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
		}

		function loadAnalytics() {
			const ctx = document.getElementById('chartArea').getContext('2d');
			new Chart(ctx, {
				type: 'doughnut',
				data: {
					labels: ['P1', 'P2', 'P3', 'P4', 'VIP'],
					datasets: [{
						data: [10, 25, 15, 8, 4],
						backgroundColor: ['#d4af37', '#ffffff', '#555', '#888', '#222'],
						borderColor: 'transparent'
					}]
				},
				options: { plugins: { legend: { position: 'bottom', labels: { color: '#aaa' } } } }
			});
		}

		window.onclick = (e) => { if(!e.target.closest('.settings-pane') && !e.target.closest('.fa-sliders')) document.getElementById('settingsPane').style.display='none'; }
	</script>
</body>
</html>
