<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Link Expert Pro | Enterprise</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg: #050505; --panel: #121214; --text: #e0e0e0; --accent: #d4af37;
            --border: rgba(212, 175, 55, 0.2); --safe: #2ecc71; --danger: #e74c3c;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; padding-bottom: 80px; }
        header { background: var(--panel); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        
        /* Indicators */
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .active-dot { background: var(--safe); box-shadow: 0 0 8px var(--safe); }
        .inactive-dot { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

        /* Settings */
        .settings-pane { display: none; position: absolute; right: 20px; top: 60px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; z-index: 200; overflow: hidden; }
        .set-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #222; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .set-item:hover { background: var(--accent); color: #000; }

        /* Cards */
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .car-card { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 15px; margin-bottom: 15px; position: relative; }
        .plate-no { font-size: 28px; font-weight: 900; letter-spacing: 2px; margin: 10px 0; color: #fff; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: #1a1a1c; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; border: 1px solid var(--border); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; box-sizing: border-box; }
        .btn { background: var(--accent); color: #000; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* Tabs */
        .dock { position: fixed; bottom: 0; width: 100%; background: var(--panel); display: flex; border-top: 1px solid var(--border); }
        .tab { flex: 1; text-align: center; padding: 15px; opacity: 0.5; font-size: 20px; cursor: pointer; }
        .tab.active { opacity: 1; color: var(--accent); }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 800; color: var(--accent);">LINK EXPERT PRO</div>
    <i class="fas fa-cog" onclick="toggleMenu(event)" style="font-size: 20px; cursor: pointer;"></i>
    <div id="settings" class="settings-pane">
        <div class="set-item" onclick="showUserAdmin()" id="admin-opt" style="display:none;"><i class="fas fa-users-cog"></i> User Management</div>
        <div class="set-item" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </div>
</header>

<div class="container" id="view-list">
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <input type="text" id="searchP" placeholder="Plate #" onkeyup="filter()">
        <input type="text" id="searchE" placeholder="Employee/Name" onkeyup="filter()">
    </div>
    <div id="results"></div>
</div>

<div class="container" id="view-add" style="display:none;">
    <div class="car-card">
        <h3>New Registration</h3>
        <input type="text" id="fClient" placeholder="Client Name">
        <input type="text" id="fPlate" placeholder="Plate Number">
        <input type="text" id="fModel" placeholder="Car Model">
        <input type="text" id="fColor" placeholder="Color">
        <input type="text" id="fEmp" placeholder="Employee Name">
        <button class="btn" onclick="saveData()">SAVE TO CLOUD</button>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-box">
        <h3>User Privileges</h3>
        <div id="user-list-items"></div>
        <button class="btn" style="background:#444; color:#fff;" onclick="closeM('userModal')">Close</button>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-box">
        <h3>Edit Vehicle</h3>
        <input type="hidden" id="eIdx">
        <input type="text" id="eClient">
        <input type="text" id="ePlate">
        <select id="eStatus">
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
        </select>
        <button class="btn" onclick="updateCar()">Update</button>
        <button class="btn" style="background:var(--danger); margin-top:5px;" onclick="deleteCar()">Delete Vehicle</button>
        <button class="btn" style="background:#444; margin-top:5px;" onclick="closeM('editModal')">Cancel</button>
    </div>
</div>

<nav class="dock">
    <div class="tab active" onclick="showPg('view-list', this)"><i class="fas fa-search"></i></div>
    <div class="tab" onclick="showPg('view-add', this)"><i class="fas fa-plus-circle"></i></div>
</nav>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMJ1n76nkM-s7fwKTJzyxbgYMR__tizWugtfnOvQONWIKChXLP4I1oUoSSzg2aaXZ9/exec"; // REPLACE THIS
    let db = [];
    let currentUser = { email: "asim@link.sa", role: "owner" }; // This would be set by your login logic

    // Boot App
    window.onload = () => {
        if(currentUser.role === 'owner') document.getElementById('admin-opt').style.display = 'flex';
        loadData();
    };

    async function loadData() {
        const res = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRytRL1hkkvWkTEnU0oSTpUSG39VuigUKFyPYcEHLwX0W76gNiGLX5sKNIXSHki16Z6JCBwE8LpW8MU/pub?gid=917848047&single=true&output=csv");
        const text = await res.text();
        const rows = text.split('\n').slice(1);
        db = rows.map((r, i) => {
            const c = r.split(',').map(v => v.trim());
            return { rowIdx: i+2, client: c[0], plate: c[1], model: c[2], color: c[3], emp: c[4], status: c[5] };
        });
        render(db);
    }

    function render(data) {
        const container = document.getElementById('results');
        container.innerHTML = '';
        data.forEach(v => {
            const card = document.createElement('div');
            card.className = 'car-card';
            if(currentUser.role === 'owner') card.onclick = () => openEdit(v);
            
            const dotClass = v.status.toLowerCase() === 'active' ? 'active-dot' : 'inactive-dot';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between">
                    <span><span class="dot ${dotClass}"></span><b>${v.client}</b></span>
                    <i class="fas fa-edit" style="opacity:0.3"></i>
                </div>
                <div class="plate-no">${v.plate}</div>
                <div style="font-size:12px; opacity:0.6">${v.model} | ${v.color}</div>
                <div style="font-size:12px; margin-top:5px; color:var(--accent)">Emp: ${v.emp}</div>
            `;
            container.appendChild(card);
        });
    }

    function filter() {
        const p = document.getElementById('searchP').value.toLowerCase();
        const e = document.getElementById('searchE').value.toLowerCase();
        const filtered = db.filter(x => x.plate.toLowerCase().includes(p) && (x.client.toLowerCase().includes(e) || x.emp.toLowerCase().includes(e)));
        render(filtered);
    }

    // Vehicle Management
    function openEdit(v) {
        document.getElementById('eIdx').value = v.rowIdx;
        document.getElementById('eClient').value = v.client;
        document.getElementById('ePlate').value = v.plate;
        document.getElementById('eStatus').value = v.status;
        document.getElementById('editModal').style.display = 'flex';
    }

    async function updateCar() {
        const payload = {
            action: "edit_car",
            rowIdx: document.getElementById('eIdx').value,
            client: document.getElementById('eClient').value,
            plate: document.getElementById('ePlate').value,
            status: document.getElementById('eStatus').value,
            model: "", color: "", emp: "" // You can add these inputs to modal if needed
        };
        await post(payload);
        location.reload();
    }

    async function deleteCar() {
        if(!confirm("Delete this vehicle?")) return;
        await post({ action: "delete", plate: document.getElementById('ePlate').value });
        location.reload();
    }

    // User Management
    function showUserAdmin() {
        const list = document.getElementById('user-list-items');
        list.innerHTML = `
            <div style="padding:10px; border-bottom:1px solid #333;">
                <b>abdullah@awtad.sa</b> (Client)
                <button class="btn" onclick="changePriv('abdullah@awtad.sa', 'owner')">Make Owner</button>
            </div>
        `;
        document.getElementById('userModal').style.display = 'flex';
    }

    async function changePriv(email, role) {
        await post({ action: "update_privilege", targetEmail: email, newRole: role });
        alert("Role Updated");
    }

    // Helpers
    async function post(data) {
        return fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
    }
    function toggleMenu(e) { e.stopPropagation(); const s = document.getElementById('settings'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }
    function showPg(id, el) { 
        document.getElementById('view-list').style.display = 'none';
        document.getElementById('view-add').style.display = 'none';
        document.getElementById(id).style.display = 'block';
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }
    function closeM(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = () => document.getElementById('settings').style.display = 'none';
</script>
</body>
</html>
